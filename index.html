<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#93c01f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Gebührenrechner" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM5M2MwMWYiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xOS4xNCAzSDQuODZjLS45NSAwLTEuNzQuNzktMS43NCAxLjc0djE0LjUyYzAgLjk1Ljc5IDEuNzQgMS43NCAxLjc0aDE0LjI4Yy45NSAwIDEuNzQtLjc5IDEuNzQtMS43NFY0Ljc0Yy0uMDEtLjk1LS44LTEuNzQtMS43NC0xLjc0ek0xMiAxMi43NWgtNXYtMS41aDVWMTJjMCAuNDEuMzQuNzUuNzUuNzVzLjc1LS4zNC43NS0uNzV2LS43NWg1djEuNWgtNXYxLjVoNXYxLjVoLTV2Mi4yNWMwIC40MS0uMzQuNzUtLjc1Ljc1cy0uNzUtLjM0LS43NS0uNzVWMTRoLTV2LTEuMjV6bTcuNS0zLjI1aC01VjhoNVY2LjVjMC0uNDEuMzQtLjc1Ljc1LS43NXMuNzUuMzQuNzUuNzVWOGg1djEuNXoiLz4KPC9zdmc+Cjwvc3ZnPg==" />
  <title>Gebührenrechner</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f9f9f9;
      padding: 20px;
      color: #333;
      margin: 0;
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    h1 {
      color: #93c01f;
      margin: 0;
    }
    
    .update-banner {
      background: #93c01f;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
    }
    
    .update-banner button {
      background: white;
      color: #93c01f;
      border: none;
      padding: 5px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: #666;
    }
    
    .online-dot, .offline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .online-dot {
      background: #4CAF50;
    }
    
    .offline-dot {
      background: #FF9800;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    .button {
      padding: 10px;
      border: none;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
    }
    
    .selected {
      background-color: #93c01f;
      color: white;
    }
    
    .unselected {
      background-color: white;
      border: 1px solid #ccc;
      color: #333;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    input[type="number"] {
      font-size: 2rem;
      padding: 0.6rem 1rem;
      width: 180px;
      border: 2px solid #93c01f;
      border-radius: 12px;
      background-color: #fdfdfd;
    }
    
    .result {
      font-size: 1.6rem;
      font-weight: bold;
    }
    
    .positive {
      color: green;
    }
    
    .negative {
      color: red;
    }
    
    .shipping-input {
      font-size: 1rem;
      padding: 0.3rem 0.5rem;
      width: 80px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-left: 5px;
    }
    
    .shipping-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    
    .shipping-name {
      font-weight: bold;
      min-width: 120px;
    }
    
    .collapsible {
      cursor: pointer;
      padding: 15px 0;
      border: none;
      background: none;
      font-size: 1.2rem;
      font-weight: bold;
      color: #93c01f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    .collapsible:hover {
      color: #7aa01a;
    }
    
    .collapsible-arrow {
      transition: transform 0.3s ease;
      font-size: 1rem;
    }
    
    .collapsible-arrow.open {
      transform: rotate(180deg);
    }
    
    .content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .content.open {
      max-height: 1000px;
    }
    
    .settings-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .action-button {
      background: #93c01f;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .action-button:hover {
      background: #7aa01a;
    }
    
    .action-button.secondary {
      background: #ccc;
      color: #333;
    }
    
    .action-button.secondary:hover {
      background: #bbb;
    }
  </style>
</head>
<body>
  <div class="app-header">
    <h1>Gebührenrechner</h1>
    <div class="status-indicator">
      <div id="connection-dot" class="online-dot"></div>
      <span id="connection-status">Online</span>
    </div>
  </div>

  <div class="update-banner" id="update-banner">
    <span>App-Update verfügbar!</span>
    <div>
      <button onclick="dismissUpdate()">Später</button>
      <button onclick="updateApp()">Jetzt aktualisieren</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>EK (Netto): <input type="number" id="netto" /></label>
      <label>VK (Brutto): <input type="number" id="brutto" /></label>
      <div class="result">Gewinn: <span id="profit" class="positive">0.00</span> €</div>
      <div class="result">mit Anzeige: <span id="profit-ads" class="positive">0.00</span> €</div>
    </div>
  </div>

  <div class="card">
    <h2>Versandoptionen</h2>
    <div class="grid" id="shipping-options"></div>
  </div>

  <div class="card">
    <p><strong>Gesamt-Versandkosten:</strong> <span id="shipping-cost">0.00</span> €</p>
    <p><strong>Provision:</strong> <span id="commission">0.00</span> €</p>
  </div>

  <div class="card">
    <h2>Provisionskategorie</h2>
    <div class="grid" id="provision-buttons"></div>
  </div>

  <div class="card">
    <button class="collapsible" onclick="toggleSettings()">
      <span>Einstellungen</span>
      <span class="collapsible-arrow" id="settings-arrow">▼</span>
    </button>
    <div class="content" id="settings-content">
      <label>Provision bis Grenze: <input type="number" id="prov1" value="6.5" />%</label><br/>
      <label>Provision über Grenze: <input type="number" id="prov2" value="2" />%</label><br/>
      <label>Grenzbetrag: <input type="number" id="provLimit" value="400" />€</label><br/>
      <label>Anzeigengebühr: <input type="number" id="adfee" value="2" />%</label><br/>
      
      <h3>Versandtarife</h3>
      <div id="shipping-settings"></div>
      
      <div class="settings-actions">
        <button class="action-button" onclick="exportSettings()">Einstellungen exportieren</button>
        <button class="action-button secondary" onclick="importSettings()">Einstellungen importieren</button>
        <button class="action-button secondary" onclick="resetSettings()">Zurücksetzen</button>
      </div>
    </div>
  </div>

  <script>
    // PWA Variables
    let updateAvailable = false;
    let deferredPrompt;
    
    // Default shipping options
    const defaultShippingOptions = [
      { name: "Kein Versand", price: 0 },
      { name: "GEL HP", price: 55.85 },
      { name: "GEL 90", price: 79.56 },
      { name: "GEL 80", price: 74.28 },
      { name: "GEL 70", price: 69.01 },
      { name: "GEL 60", price: 62.89 },
      { name: "GEL 50", price: 56.01 },
      { name: "GEL 40", price: 47.99 },
      { name: "GEL 30", price: 44.78 },
      { name: "GEL 20", price: 37.60 },
      { name: "GEL 10", price: 30.72 },
      { name: "Wüst Karton", price: 151.08 },
      { name: "DHL HP", price: 58.51 },
      { name: "DHL XP", price: 76.68 },
      { name: "DHL KT", price: 55.54 },
      { name: "DHL Paket", price: 5.32 },
    ];

    let shippingOptions = [];
    let selectedShipping = null;

    // Load settings from storage or defaults
    function loadSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem('gebuehrenrechner-settings') || '{}');
        
        // Load shipping options
        shippingOptions = saved.shippingOptions || [...defaultShippingOptions];
        
        // Load other settings
        if (saved.prov1) document.getElementById("prov1").value = saved.prov1;
        if (saved.prov2) document.getElementById("prov2").value = saved.prov2;
        if (saved.provLimit) document.getElementById("provLimit").value = saved.provLimit;
        if (saved.adfee) document.getElementById("adfee").value = saved.adfee;
        
      } catch (error) {
        console.log('Using default settings');
        shippingOptions = [...defaultShippingOptions];
      }
    }

    // Save settings to storage
    function saveSettings() {
      try {
        const settings = {
          shippingOptions: shippingOptions,
          prov1: document.getElementById("prov1").value,
          prov2: document.getElementById("prov2").value,
          provLimit: document.getElementById("provLimit").value,
          adfee: document.getElementById("adfee").value,
          lastUpdated: Date.now()
        };
        localStorage.setItem('gebuehrenrechner-settings', JSON.stringify(settings));
      } catch (error) {
        console.log('Could not save settings');
      }
    }

    function createShippingSettings() {
      const container = document.getElementById("shipping-settings");
      container.innerHTML = '';
      
      shippingOptions.forEach((opt, index) => {
        const div = document.createElement("div");
        div.className = "shipping-row";
        
        const nameSpan = document.createElement("span");
        nameSpan.className = "shipping-name";
        nameSpan.textContent = opt.name;
        
        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.className = "shipping-input";
        priceInput.value = opt.price;
        priceInput.step = "0.01";
        priceInput.addEventListener("input", () => {
          shippingOptions[index].price = parseFloat(priceInput.value) || 0;
          updateCalculations();
          saveSettings();
        });
        
        const euroSpan = document.createElement("span");
        euroSpan.textContent = " €";
        
        div.appendChild(nameSpan);
        div.appendChild(priceInput);
        div.appendChild(euroSpan);
        container.appendChild(div);
      });
    }

    function createShippingButtons() {
      const container = document.getElementById("shipping-options");
      container.innerHTML = '';
      
      shippingOptions.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = `${opt.name}`;
        btn.className = "button unselected";
        btn.onclick = () => {
          [...container.children].forEach(child => child.className = "button unselected");
          btn.className = "button selected";
          selectedShipping = opt;
          updateCalculations();
        };
        container.appendChild(btn);
      });
    }

    // Event listeners for calculations
    document.getElementById("netto").addEventListener("input", () => {
      updateCalculations();
      saveSettings();
    });
    document.getElementById("brutto").addEventListener("input", () => {
      updateCalculations();
      saveSettings();
    });
    document.getElementById("prov1").addEventListener("input", () => {
      updateCalculations();
      saveSettings();
    });
    document.getElementById("prov2").addEventListener("input", () => {
      updateCalculations();
      saveSettings();
    });
    document.getElementById("adfee").addEventListener("input", () => {
      updateCalculations();
      saveSettings();
    });
    document.getElementById("provLimit").addEventListener("input", () => {
      updateCalculations();
      saveSettings();
    });

    function updateCalculations() {
      const netto = parseFloat(document.getElementById("netto").value) || 0;
      const brutto = parseFloat(document.getElementById("brutto").value) || 0;
      const prov1 = parseFloat(document.getElementById("prov1").value) || 6.5;
      const provLimit = parseFloat(document.getElementById("provLimit").value) || 400;
      const prov2 = parseFloat(document.getElementById("prov2").value) || 2;
      const adfeePercent = parseFloat(document.getElementById("adfee").value) || 0;

      const versand = selectedShipping ? selectedShipping.price : 0;

      let provision = 0;
      if (selectedShipping && selectedShipping.name !== "Kein Versand") {
        provision = (brutto <= provLimit 
          ? brutto * (prov1 / 100) 
          : provLimit * (prov1 / 100) + (brutto - provLimit) * (prov2 / 100)) + 0.35;
      }

      const nettoVK = brutto / 1.19;
      const gewinn = nettoVK - netto - versand - provision;
      const gewinnMitAnzeige = gewinn - (nettoVK * adfeePercent / 100);

      const profitEl = document.getElementById("profit");
      const profitAdsEl = document.getElementById("profit-ads");

      profitEl.textContent = gewinn.toFixed(2);
      profitAdsEl.textContent = gewinnMitAnzeige.toFixed(2);

      profitEl.className = gewinn >= 0 ? "positive" : "negative";
      profitAdsEl.className = gewinnMitAnzeige >= 0 ? "positive" : "negative";

      document.getElementById("shipping-cost").textContent = versand.toFixed(2);
      document.getElementById("commission").textContent = provision.toFixed(2);
    }

    const provisionCategories = [
      { name: "Haushaltsgeräte", prov1: 6.5, prov2: 2, limit: 400 },
      { name: "Haushaltsgeräte klein", prov1: 6.5, prov2: 2, limit: 400 },
      { name: "Heimwerker", prov1: 12, prov2: 2, limit: 200 },
      { name: "Garten & Terrasse", prov1: 12, prov2: 2, limit: 200 },
      { name: "TV, Video & Audio", prov1: 6.5, prov2: 2, limit: 400 },
      { name: "TV- & Heim-Audio-Zubehör", prov1: 11, prov2: 2, limit: 200 }
    ];

    const provContainer = document.getElementById("provision-buttons");
    provisionCategories.forEach(cat => {
      const btn = document.createElement("button");
      btn.textContent = cat.name;
      btn.className = "button unselected";
      btn.onclick = () => {
        [...provContainer.children].forEach(child => child.className = "button unselected");
        btn.className = "button selected";
        document.getElementById("prov1").value = cat.prov1;
        document.getElementById("prov2").value = cat.prov2;
        document.getElementById("provLimit").value = cat.limit;
        updateCalculations();
        saveSettings();
      };
      provContainer.appendChild(btn);
    });

    function toggleSettings() {
      const content = document.getElementById("settings-content");
      const arrow = document.getElementById("settings-arrow");
      
      if (content.classList.contains("open")) {
        content.classList.remove("open");
        arrow.classList.remove("open");
      } else {
        content.classList.add("open");
        arrow.classList.add("open");
      }
    }

    // Settings management
    function exportSettings() {
      const settings = {
        shippingOptions: shippingOptions,
        prov1: document.getElementById("prov1").value,
        prov2: document.getElementById("prov2").value,
        provLimit: document.getElementById("provLimit").value,
        adfee: document.getElementById("adfee").value,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gebuehrenrechner-settings.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const settings = JSON.parse(e.target.result);
              
              if (settings.shippingOptions) {
                shippingOptions = settings.shippingOptions;
                createShippingButtons();
                createShippingSettings();
              }
              
              if (settings.prov1) document.getElementById("prov1").value = settings.prov1;
              if (settings.prov2) document.getElementById("prov2").value = settings.prov2;
              if (settings.provLimit) document.getElementById("provLimit").value = settings.provLimit;
              if (settings.adfee) document.getElementById("adfee").value = settings.adfee;
              
              saveSettings();
              updateCalculations();
              alert('Einstellungen erfolgreich importiert!');
            } catch (error) {
              alert('Fehler beim Importieren der Einstellungen!');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function resetSettings() {
      if (confirm('Alle Einstellungen auf Standard zurücksetzen?')) {
        shippingOptions = [...defaultShippingOptions];
        document.getElementById("prov1").value = 6.5;
        document.getElementById("prov2").value = 2;
        document.getElementById("provLimit").value = 400;
        document.getElementById("adfee").value = 2;
        
        createShippingButtons();
        createShippingSettings();
        saveSettings();
        updateCalculations();
      }
    }

    // PWA Functions
    function updateConnectionStatus() {
      const dot = document.getElementById('connection-dot');
      const status = document.getElementById('connection-status');
      
      if (navigator.onLine) {
        dot.className = 'online-dot';
        status.textContent = 'Online';
      } else {
        dot.className = 'offline-dot';
        status.textContent = 'Offline';
      }
    }

    function updateApp() {
      if (updateAvailable) {
        window.location.reload();
      }
    }

    function dismissUpdate() {
      document.getElementById('update-banner').style.display = 'none';
    }

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(createServiceWorker())
          .then(reg => {
            console.log('Service Worker registered:', reg);
            
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  updateAvailable = true;
                  document.getElementById('update-banner').style.display = 'flex';
                }
              });
            });
          })
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }

    // Create Service Worker as Blob URL
    function createServiceWorker() {
      const swCode = `
        const CACHE_NAME = 'gebuehrenrechner-v1.0.0';
        const urlsToCache = [
          './',
          './index.html'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
              .then(() => self.skipWaiting())
          );
        });

        self.addEventListener('activate', event => {
          event.waitUntil(
            caches.keys().then(cacheNames => {
              return Promise.all(
                cacheNames.map(cacheName => {
                  if (cacheName !== CACHE_NAME) {
                    return caches.delete(cacheName);
                  }
                })
              );
            }).then(() => self.clients.claim())
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => {
                // Cache first strategy
                if (response) {
                  return response;
                }
                return fetch(event.request);
              })
          );
        });
      `;
      
      const blob = new Blob([swCode], { type: 'application/javascript' });
      return URL.createObjectURL(blob);
    }

    // Event listeners
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);

    // Install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Initialize app
    loadSettings();
    createShippingButtons();
    createShippingSettings();
    updateConnectionStatus();
    updateCalculations();
  </script>
</body>
</html>
